<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <title>Profile ‚Äî Expense Tracker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --border: #e5e7eb;
      --accent: #3f67e6;
      --accent-soft: #e0e7ff;
      --accent-dark: #2949c0;
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #f59e0b;
      --muted: #6b7280;
      --text: #0b2340;
      --text-soft: #9ca3af;
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
      --radius-lg: 18px;
      --radius-sm: 10px;
      --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    :root[data-theme="dark"] {
      --bg: #020617;
      --card: #0f172a;
      --border: #1e293b;
      --accent: #60a5fa;
      --accent-soft: #0b1120;
      --accent-dark: #2563eb;
      --danger: #f97373;
      --success: #34d399;
      --warning: #fbbf24;
      --muted: #9ca3af;
      --text: #e5e7eb;
      --text-soft: #6b7280;
      --shadow: 0 10px 40px rgba(15, 23, 42, 0.7);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, rgba(96,165,250,0.18), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(139,92,246,0.18), transparent 55%),
                  var(--bg);
      min-height: 100vh;
      color: var(--text);
    }

    .wrap {
      max-width: 900px;
      margin: 0 auto;
      padding: 18px 16px 40px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }

    header h1 {
      font-size: 26px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header h1 span {
      font-size: 28px;
    }

    .back-link {
      text-decoration: none;
      color: var(--accent);
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(148,163,184,0.12);
      border: 1px solid rgba(148,163,184,0.25);
      font-size: 13px;
    }

    .back-link:hover {
      background: rgba(148,163,184,0.2);
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 18px 18px 20px;
      position: relative;
      overflow: hidden;
      margin-bottom: 18px;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(96,165,250,0.12), transparent 60%);
      pointer-events: none;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      position: relative;
      z-index: 1;
    }

    .card-title {
      font-weight: 700;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .muted {
      font-size: 12px;
      color: var(--muted);
    }

    .btn {
      border: 0;
      border-radius: 999px;
      padding: 9px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all var(--transition);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.18);
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      color: white;
    }

    .btn-secondary {
      background: rgba(148,163,184,0.14);
      color: var(--text);
      box-shadow: none;
    }

    .btn-danger {
      background: rgba(239,68,68,0.15);
      color: var(--danger);
      box-shadow: none;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn:active {
      transform: scale(0.96);
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
      position: relative;
      z-index: 1;
    }

    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      flex-shrink: 0;
      overflow: hidden;
      cursor: pointer;
      position: relative;
      border: 3px solid var(--border);
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .avatar-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      opacity: 0;
      transition: opacity var(--transition);
    }

    .profile-avatar:hover .avatar-overlay {
      opacity: 1;
    }

    #profilePicInput {
      display: none;
    }

    .profile-info h2 {
      font-size: 18px;
      margin-bottom: 4px;
    }

    .profile-info p {
      font-size: 13px;
      color: var(--muted);
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid rgba(148,163,184,0.2);
      position: relative;
      z-index: 1;
    }

    .setting-item:last-child {
      border-bottom: none;
    }

    .setting-label {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .setting-title {
      font-weight: 600;
      font-size: 14px;
    }

    .setting-desc {
      font-size: 12px;
      color: var(--muted);
    }

    .setting-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toggle {
      width: 44px;
      height: 24px;
      background: rgba(148,163,184,0.3);
      border-radius: 999px;
      cursor: pointer;
      position: relative;
      transition: all var(--transition);
    }

    .toggle.active {
      background: var(--success);
    }

    .toggle-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: white;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: left var(--transition);
    }

    .toggle.active .toggle-thumb {
      left: 22px;
    }

    .currency-search-container {
      position: relative;
    }

    .currency-search {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      background: var(--card);
      color: var(--text);
      font-size: 13px;
    }

    .currency-search:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(63, 103, 230, 0.1);
    }

    .currency-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card);
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.15);
    }

    .currency-dropdown.show {
      display: block;
    }

    .currency-option {
      padding: 10px 12px;
      cursor: pointer;
      font-size: 13px;
      border-bottom: 1px solid rgba(148,163,184,0.1);
      transition: all var(--transition);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .currency-option:hover {
      background: var(--accent-soft);
      color: var(--accent);
    }

    .currency-option.selected {
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }

    .currency-code {
      font-weight: 600;
      color: var(--accent);
      margin-right: 8px;
    }

    .currency-symbol {
      color: var(--muted);
      font-size: 11px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      position: relative;
      z-index: 1;
    }

    .stat-label {
      font-size: 13px;
      color: var(--muted);
    }

    .stat-value {
      font-weight: 700;
      color: var(--accent);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 18px;
      position: relative;
      z-index: 1;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(96,165,250,0.1), rgba(139,92,246,0.1));
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 15px;
      text-align: center;
    }

    .stat-card-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 6px;
    }

    .stat-card-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      font-weight: 500;
    }

    .section-divider {
      border-top: 1px solid var(--border);
      margin: 15px 0;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 6px;
    }

    .form-group input {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      background: var(--card);
      color: var(--text);
      font-size: 13px;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(63, 103, 230, 0.1);
    }

    .danger-zone {
      background: linear-gradient(135deg, rgba(239,68,68,0.08), rgba(239,68,68,0.04));
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: var(--radius-lg);
      padding: 18px;
      position: relative;
      z-index: 1;
    }

    .danger-title {
      font-weight: 700;
      color: var(--danger);
      font-size: 14px;
      margin-bottom: 8px;
    }

    .danger-desc {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .info-box {
      background: linear-gradient(135deg, rgba(63,103,230,0.08), rgba(139,92,246,0.08));
      border-left: 4px solid var(--accent);
      border-radius: var(--radius-sm);
      padding: 12px;
      margin-bottom: 12px;
      font-size: 13px;
      position: relative;
      z-index: 1;
    }

    .info-box strong {
      color: var(--accent);
    }

    .action-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }

    @media (max-width: 768px) {
      .profile-header {
        flex-direction: column;
        text-align: center;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .action-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <a class="back-link" href="dashboard.html">‚Üê Back to Dashboard</a>
      <h1><span>üë§</span> Profile</h1>
    </div>
  </header>

  <!-- ============ PROFILE HEADER ============ -->
  <section class="card">
    <div class="profile-header">
      <div class="profile-avatar" id="profileAvatar" onclick="document.getElementById('profilePicInput').click()">
        <span id="avatarText">üë§</span>
        <img id="avatarImage" style="display: none;" />
        <div class="avatar-overlay">üì∑ Upload</div>
      </div>
      <input type="file" id="profilePicInput" accept="image/*" onchange="uploadProfilePic(event)" />
      <div class="profile-info">
        <h2 id="userName">User Profile</h2>
        <p id="userEmail">Managing your expenses efficiently</p>
        <p id="userJoinDate" style="margin-top: 8px; font-size: 11px; color: var(--text-soft);">Joined today</p>
      </div>
    </div>
  </section>

  <!-- ============ QUICK STATS ============ -->
  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">üìä Your Statistics</div>
        <div class="muted">Overview of your spending activity</div>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-card-value" id="totalExpenses">0</div>
        <div class="stat-card-label">Total Expenses</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-value" id="totalAmount">‚Çπ0</div>
        <div class="stat-card-label">Total Spent</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-value" id="avgExpense">‚Çπ0</div>
        <div class="stat-card-label">Average</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-value" id="totalGoals">0</div>
        <div class="stat-card-label">Goals Set</div>
      </div>
    </div>
  </section>

  <!-- ============ SETTINGS ============ -->
  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">‚öôÔ∏è Settings</div>
        <div class="muted">Customize your experience</div>
      </div>
    </div>

    <!-- Theme Toggle -->
    <div class="setting-item">
      <div class="setting-label">
        <span class="setting-title">Dark Mode</span>
        <span class="setting-desc">Enable dark theme for the app</span>
      </div>
      <div class="setting-control">
        <div class="toggle" id="themeToggle" onclick="toggleTheme()">
          <div class="toggle-thumb"></div>
        </div>
      </div>
    </div>

    <!-- Currency Selection with Search -->
    <div style="border-bottom: 1px solid rgba(148,163,184,0.2); padding-bottom: 15px; margin-bottom: 15px;">
      <div class="setting-label" style="margin-bottom: 10px;">
        <span class="setting-title">Currency</span>
        <span class="setting-desc">Choose your preferred currency</span>
      </div>
      <div class="currency-search-container">
        <input type="text" class="currency-search" id="currencySearch" placeholder="Search currency (e.g., USD, Euro, Rupee)..." />
        <div class="currency-dropdown" id="currencyDropdown"></div>
      </div>
    </div>

    <!-- Notification Preference -->
    <div class="setting-item">
      <div class="setting-label">
        <span class="setting-title">Enable Notifications</span>
        <span class="setting-desc">Get alerts about budget limits</span>
      </div>
      <div class="setting-control">
        <div class="toggle" id="notifToggle" onclick="toggleNotifications()">
          <div class="toggle-thumb"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ============ ACCOUNT ============ -->
  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">üë§ Account</div>
        <div class="muted">Manage your account information</div>
      </div>
    </div>

    <div class="form-group">
      <label>Display Name</label>
      <input type="text" id="displayName" placeholder="Enter your name" />
    </div>

    <div class="form-group">
      <label>Email Address</label>
      <input type="email" id="userEmailInput" placeholder="your@email.com" />
    </div>

    <button class="btn btn-primary" onclick="saveProfile()" style="width: 100%; margin-top: 10px;">üíæ Save Changes</button>
  </section>

  <!-- ============ DATA MANAGEMENT ============ -->
  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">üíæ Data Management</div>
        <div class="muted">Export and backup your data</div>
      </div>
    </div>

    <div class="info-box">
      <strong>üí° Tip:</strong> Download a backup of all your expenses, goals, and settings to keep them safe.
    </div>

    <div class="action-grid">
      <button class="btn btn-primary" onclick="exportAllData()">üì• Export All Data</button>
      <button class="btn btn-secondary" onclick="exportExpenses()">üìä Expenses Only</button>
      <button class="btn btn-secondary" onclick="exportGoals()">üéØ Goals Only</button>
    </div>

    <div class="section-divider"></div>

    <div style="margin-top: 15px; position: relative; z-index: 1;">
      <div class="muted" style="margin-bottom: 10px;">Storage Usage</div>
      <div style="display: flex; gap: 12px; margin-bottom: 12px;">
        <div style="flex: 1;">
          <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Used Space</div>
          <div style="font-size: 14px; font-weight: 700;" id="storageUsed">--</div>
        </div>
        <div style="flex: 1;">
          <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Available</div>
          <div style="font-size: 14px; font-weight: 700;" id="storageAvailable">--</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ============ PRIVACY & SECURITY ============ -->
  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">üîí Privacy & Security</div>
        <div class="muted">Manage your privacy settings</div>
      </div>
    </div>

    <div class="setting-item">
      <div class="setting-label">
        <span class="setting-title">Local Storage Only</span>
        <span class="setting-desc">All data is stored locally on your device</span>
      </div>
      <div style="color: var(--success); font-weight: 600;">‚úì Secure</div>
    </div>

    <div class="setting-item">
      <div class="setting-label">
        <span class="setting-title">No Cloud Sync</span>
        <span class="setting-desc">Your data never leaves your device</span>
      </div>
      <div style="color: var(--success); font-weight: 600;">‚úì Private</div>
    </div>

    <div class="setting-item">
      <div class="setting-label">
        <span class="setting-title">Clear Browser Cache</span>
        <span class="setting-desc">Clear app data from your browser</span>
      </div>
      <button class="btn btn-danger" onclick="clearCache()">Clear Cache</button>
    </div>
  </section>

  <!-- ============ ABOUT ============ -->
  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">‚ÑπÔ∏è About</div>
        <div class="muted">Information and version details</div>
      </div>
    </div>

    <div class="stat-item">
      <div class="stat-label">App Name</div>
      <div class="stat-value">Expense Tracker</div>
    </div>

    <div class="stat-item">
      <div class="stat-label">Version</div>
      <div class="stat-value">1.0.0</div>
    </div>

    <div class="stat-item">
      <div class="stat-label">Last Updated</div>
      <div class="stat-value" id="lastUpdated">Today</div>
    </div>

    <div class="stat-item">
      <div class="stat-label">Database</div>
      <div class="stat-value">Local Storage</div>
    </div>
  </section>

  <!-- ============ DANGER ZONE ============ -->
  <section class="card">
    <div class="danger-zone">
      <div class="danger-title">‚ö†Ô∏è Danger Zone</div>
      <div class="danger-desc">These actions cannot be undone. Please be careful.</div>
      <button class="btn btn-danger" onclick="resetAllData()" style="width: 100%;">üóëÔ∏è Delete All Data</button>
    </div>
  </section>
</div>

<script>
  const SETTINGS_KEY = "userSettings";
  const EXPENSES_KEY = "userExpenses";
  const GOALS_KEY = "userGoals";
  const PROFILE_KEY = "userProfile";

  const CURRENCIES = [
    { code: "INR", symbol: "‚Çπ", name: "Indian Rupee" },
    { code: "USD", symbol: "$", name: "US Dollar" },
    { code: "EUR", symbol: "‚Ç¨", name: "Euro" },
    { code: "GBP", symbol: "¬£", name: "British Pound" },
    { code: "JPY", symbol: "¬•", name: "Japanese Yen" },
    { code: "AUD", symbol: "A$", name: "Australian Dollar" },
    { code: "CAD", symbol: "C$", name: "Canadian Dollar" },
    { code: "CHF", symbol: "CHF", name: "Swiss Franc" },
    { code: "CNY", symbol: "¬•", name: "Chinese Yuan" },
    { code: "SEK", symbol: "kr", name: "Swedish Krona" },
    { code: "NZD", symbol: "$", name: "New Zealand Dollar" },
    { code: "MXN", symbol: "$", name: "Mexican Peso" },
    { code: "SGD", symbol: "$", name: "Singapore Dollar" },
    { code: "HKD", symbol: "$", name: "Hong Kong Dollar" },
    { code: "NOK", symbol: "kr", name: "Norwegian Krone" },
    { code: "KRW", symbol: "‚Ç©", name: "South Korean Won" },
    { code: "TRY", symbol: "‚Ç∫", name: "Turkish Lira" },
    { code: "RUB", symbol: "‚ÇΩ", name: "Russian Ruble" },
    { code: "BRL", symbol: "R$", name: "Brazilian Real" },
    { code: "ZAR", symbol: "R", name: "South African Rand" },
    { code: "AED", symbol: "ÿØ.ÿ•", name: "UAE Dirham" },
    { code: "SAR", symbol: "Ô∑º", name: "Saudi Riyal" },
    { code: "THB", symbol: "‡∏ø", name: "Thai Baht" },
    { code: "PHP", symbol: "‚Ç±", name: "Philippine Peso" },
    { code: "MYR", symbol: "RM", name: "Malaysian Ringgit" },
    { code: "IDR", symbol: "Rp", name: "Indonesian Rupiah" },
    { code: "VND", symbol: "‚Ç´", name: "Vietnamese Dong" },
    { code: "TWD", symbol: "$", name: "Taiwan Dollar" },
    { code: "PKR", symbol: "‚Ç®", name: "Pakistani Rupee" },
    { code: "BDT", symbol: "‡ß≥", name: "Bangladeshi Taka" },
    { code: "ARS", symbol: "$", name: "Argentine Peso" },
    { code: "CLP", symbol: "$", name: "Chilean Peso" },
    { code: "COP", symbol: "$", name: "Colombian Peso" },
    { code: "DKK", symbol: "kr", name: "Danish Krone" },
    { code: "ILS", symbol: "‚Ç™", name: "Israeli Shekel" },
    { code: "QAR", symbol: "ÿ±.ŸÇ", name: "Qatari Riyal" },
    { code: "HUF", symbol: "Ft", name: "Hungarian Forint" },
    { code: "CZK", symbol: "Kƒç", name: "Czech Koruna" },
    { code: "PLN", symbol: "z≈Ç", name: "Polish Zloty" },
    { code: "RON", symbol: "lei", name: "Romanian Leu" },
    { code: "BGN", symbol: "–ª–≤", name: "Bulgarian Lev" },
    { code: "HRK", symbol: "kn", name: "Croatian Kuna" },
    { code: "ISK", symbol: "kr", name: "Icelandic Kr√≥na" },
    { code: "NGN", symbol: "‚Ç¶", name: "Nigerian Naira" },
    { code: "KES", symbol: "KSh", name: "Kenyan Shilling" },
    { code: "GHS", symbol: "‚Çµ", name: "Ghanaian Cedi" },
    { code: "EGP", symbol: "¬£", name: "Egyptian Pound" },
    { code: "MAD", symbol: "ÿØ.ŸÖ.", name: "Moroccan Dirham" },
    { code: "UGX", symbol: "USh", name: "Ugandan Shilling" },
    { code: "TZS", symbol: "TSh", name: "Tanzanian Shilling" }
  ];

  function getSettings() {
    try { return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {}; }
    catch { return {}; }
  }

  function saveSettings(settings) {
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  }

  function getProfile() {
    try { return JSON.parse(localStorage.getItem(PROFILE_KEY)) || {}; }
    catch { return {}; }
  }

  function applySettings() {
    const settings = getSettings();
    const theme = settings.theme === "dark" ? "dark" : "light";
    document.documentElement.setAttribute("data-theme", theme);

    const isDark = theme === "dark";
    const themeToggle = document.getElementById("themeToggle");
    if (isDark) themeToggle.classList.add("active");
    else themeToggle.classList.remove("active");

    const notifEnabled = settings.notifications !== false;
    const notifToggle = document.getElementById("notifToggle");
    if (notifEnabled) notifToggle.classList.add("active");
    else notifToggle.classList.remove("active");
  }

  function initCurrencyDropdown() {
    const currentCurrency = getSettings().currency || "INR";
    const dropdown = document.getElementById("currencyDropdown");
    const search = document.getElementById("currencySearch");

    function renderOptions(filter = "") {
      const filtered = CURRENCIES.filter(c => 
        c.code.toLowerCase().includes(filter.toLowerCase()) ||
        c.name.toLowerCase().includes(filter.toLowerCase())
      );

      dropdown.innerHTML = filtered.map(c => `
        <div class="currency-option ${c.code === currentCurrency ? 'selected' : ''}" onclick="selectCurrency('${c.code}')">
          <span><span class="currency-code">${c.code}</span> ${c.name}</span>
          <span class="currency-symbol">${c.symbol}</span>
        </div>
      `).join("");
    }

    search.addEventListener("focus", () => {
      dropdown.classList.add("show");
      renderOptions(search.value);
    });

    search.addEventListener("input", (e) => {
      dropdown.classList.add("show");
      renderOptions(e.target.value);
    });

    document.addEventListener("click", (e) => {
      if (!e.target.closest(".currency-search-container")) {
        dropdown.classList.remove("show");
      }
    });

    renderOptions();
  }

  function selectCurrency(code) {
    const settings = getSettings();
    settings.currency = code;
    saveSettings(settings);
    document.getElementById("currencySearch").value = CURRENCIES.find(c => c.code === code)?.name || "";
    document.getElementById("currencyDropdown").classList.remove("show");
    initCurrencyDropdown();
    updateStats();
  }

  function uploadProfilePic(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      const profile = getProfile();
      profile.profilePic = e.target.result;
      localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
      loadProfile();
    };
    reader.readAsDataURL(file);
  }

  function toggleTheme() {
    const settings = getSettings();
    settings.theme = settings.theme === "dark" ? "light" : "dark";
    saveSettings(settings);
    applySettings();
  }

  function toggleNotifications() {
    const settings = getSettings();
    settings.notifications = settings.notifications !== false ? false : true;
    saveSettings(settings);
    applySettings();
  }

  function saveProfile() {
    const profile = getProfile();
    profile.name = document.getElementById("displayName").value;
    profile.email = document.getElementById("userEmailInput").value;
    profile.joinDate = profile.joinDate || new Date().toISOString();
    localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
    alert("‚úì Profile saved successfully!");
  }

  function loadProfile() {
    const profile = getProfile();
    document.getElementById("displayName").value = profile.name || "User";
    document.getElementById("userEmailInput").value = profile.email || "";
    document.getElementById("userName").innerText = profile.name || "User Profile";
    document.getElementById("userEmail").innerText = profile.email || "Managing your expenses efficiently";

    const joinDate = new Date(profile.joinDate || Date.now());
    document.getElementById("userJoinDate").innerText = `Joined ${joinDate.toLocaleDateString('en-IN')}`;

    if (profile.profilePic) {
      const avatarImage = document.getElementById("avatarImage");
      const avatarText = document.getElementById("avatarText");
      avatarImage.src = profile.profilePic;
      avatarImage.style.display = "block";
      avatarText.style.display = "none";
    }
  }

  function updateStats() {
    const expenses = JSON.parse(localStorage.getItem(EXPENSES_KEY)) || [];
    const goals = JSON.parse(localStorage.getItem(GOALS_KEY)) || [];
    const settings = getSettings();
    const currencyCode = settings.currency || "INR";
    const currency = CURRENCIES.find(c => c.code === currencyCode);
    const symbol = currency?.symbol || "‚Çπ";

    const total = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
    const avg = expenses.length > 0 ? Math.round(total / expenses.length) : 0;

    document.getElementById("totalExpenses").innerText = expenses.length;
    document.getElementById("totalAmount").innerText = symbol + total.toLocaleString("en-IN");
    document.getElementById("avgExpense").innerText = symbol + avg.toLocaleString("en-IN");
    document.getElementById("totalGoals").innerText = goals.length;

    updateStorageInfo();
  }

  function updateStorageInfo() {
    const used = JSON.stringify(localStorage).length;
    const usedKB = (used / 1024).toFixed(2);
    document.getElementById("storageUsed").innerText = usedKB + " KB";

    if (navigator.storage && navigator.storage.estimate) {
      navigator.storage.estimate().then(estimate => {
        const availableKB = ((estimate.quota - estimate.usage) / 1024).toFixed(2);
        document.getElementById("storageAvailable").innerText = availableKB + " KB";
      });
    } else {
      document.getElementById("storageAvailable").innerText = "Unknown";
    }
  }

  function exportAllData() {
    const data = {
      expenses: JSON.parse(localStorage.getItem(EXPENSES_KEY)) || [],
      goals: JSON.parse(localStorage.getItem(GOALS_KEY)) || [],
      settings: JSON.parse(localStorage.getItem(SETTINGS_KEY)) || [],
      profile: JSON.parse(localStorage.getItem(PROFILE_KEY)) || {},
      exportDate: new Date().toISOString()
    };

    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `expense-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
  }

  function exportExpenses() {
    const expenses = JSON.parse(localStorage.getItem(EXPENSES_KEY)) || [];
    let csv = "Date,Category,Amount,Note,Currency\n";
    expenses.forEach(e => {
      const date = new Date(e.date).toLocaleDateString("en-IN");
      csv += `${date},${e.category},${e.amount},"${e.note}",${e.currency}\n`;
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `expenses-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
  }

  function exportGoals() {
    const goals = JSON.parse(localStorage.getItem(GOALS_KEY)) || [];
    const json = JSON.stringify(goals, null, 2);
    const blob = new Blob([json], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `goals-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
  }

  function clearCache() {
    if (confirm("Clear app cache? This will not delete your data.")) {
      localStorage.clear();
      alert("‚úì Cache cleared! Please refresh the page.");
      location.reload();
    }
  }

  function resetAllData() {
    if (confirm("‚ö†Ô∏è This will DELETE ALL your data! Are you sure?")) {
      if (confirm("This action CANNOT be undone. Really delete everything?")) {
        localStorage.clear();
        alert("‚úì All data deleted. Refreshing...");
        location.reload();
      }
    }
  }

  window.saveProfile = saveProfile;
  window.toggleTheme = toggleTheme;
  window.toggleNotifications = toggleNotifications;
  window.selectCurrency = selectCurrency;
  window.uploadProfilePic = uploadProfilePic;
  window.exportAllData = exportAllData;
  window.exportExpenses = exportExpenses;
  window.exportGoals = exportGoals;
  window.clearCache = clearCache;
  window.resetAllData = resetAllData;

  applySettings();
  initCurrencyDropdown();
  loadProfile();
  updateStats();
</script>
</body>
</html>