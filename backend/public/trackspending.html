<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <title>Track Spending ‚Äî Expense Tracker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --border: #e5e7eb;
      --accent: #3f67e6;
      --accent-soft: #e0e7ff;
      --accent-dark: #2949c0;
      --danger: #ef4444;
      --muted: #6b7280;
      --text: #0b2340;
      --text-soft: #9ca3af;
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
      --radius-lg: 18px;
      --radius-sm: 10px;
      --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    :root[data-theme="dark"] {
      --bg: #020617;
      --card: #0f172a;
      --border: #1e293b;
      --accent: #60a5fa;
      --accent-soft: #0b1120;
      --accent-dark: #2563eb;
      --danger: #f97373;
      --muted: #9ca3af;
      --text: #e5e7eb;
      --text-soft: #6b7280;
      --shadow: 0 10px 40px rgba(15, 23, 42, 0.7);
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, rgba(96,165,250,0.18), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(139,92,246,0.18), transparent 55%),
                  var(--bg);
      min-height: 100vh;
      color: var(--text);
    }
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 16px 40px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }
    header h1 {
      font-size: 26px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    header h1 span {
      font-size: 28px;
    }
    .back-link {
      text-decoration: none;
      color: var(--accent);
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(148,163,184,0.12);
      border: 1px solid rgba(148,163,184,0.25);
      font-size: 13px;
    }
    .back-link:hover {
      background: rgba(148,163,184,0.2);
    }
    .settings-pill {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px dashed var(--border);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .settings-pill span {
      font-weight: 600;
      color: var(--accent);
    }
    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 18px 18px 20px;
      position: relative;
      overflow: hidden;
      margin-bottom: 18px;
    }
    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(96,165,250,0.12), transparent 60%);
      pointer-events: none;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      position: relative;
      z-index: 1;
    }
    .card-title {
      font-weight: 700;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .chip {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }
    .muted {
      font-size: 12px;
      color: var(--muted);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
      margin-bottom: 15px;
    }
    .stat-card {
      background: linear-gradient(135deg, rgba(96,165,250,0.1), rgba(139,92,246,0.1));
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 15px;
      position: relative;
      overflow: hidden;
    }
    .stat-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(96,165,250,0.15), transparent 60%);
      pointer-events: none;
    }
    .stat-label {
      font-size: 12px;
      color: var(--muted);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
      position: relative;
      z-index: 1;
    }
    .stat-subtext {
      font-size: 11px;
      color: var(--muted);
      margin-top: 6px;
      position: relative;
      z-index: 1;
    }
    .controls-row {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .btn {
      border: 0;
      border-radius: 999px;
      padding: 9px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all var(--transition);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.18);
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      color: white;
    }
    .btn-secondary {
      background: rgba(148,163,184,0.14);
      color: var(--text);
      box-shadow: none;
    }
    .btn:hover {
      transform: translateY(-2px);
    }
    .btn:active {
      transform: scale(0.96);
    }
    .chart-container {
      position: relative;
      width: 100%;
      height: 300px;
      margin-bottom: 15px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 12px;
      background: rgba(15,23,42,0.02);
    }
    .filter-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    input[type="date"], select {
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px 10px;
      background: var(--card);
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
    }
    input[type="date"]:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(63, 103, 230, 0.1);
    }
    .insight-box {
      background: linear-gradient(135deg, rgba(63, 103, 230, 0.08), rgba(139, 92, 246, 0.08));
      border-left: 4px solid var(--accent);
      border-radius: var(--radius-sm);
      padding: 12px;
      margin-bottom: 12px;
      font-size: 13px;
      position: relative;
      z-index: 1;
    }
    .insight-box strong {
      color: var(--accent);
    }
    .suggestion-box {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.08), rgba(96, 165, 250, 0.08));
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: var(--radius-lg);
      padding: 15px;
      margin-bottom: 15px;
      position: relative;
      z-index: 1;
    }
    .suggestion-title {
      font-weight: 700;
      color: #22c55e;
      font-size: 14px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .suggestion-item {
      font-size: 12px;
      color: var(--text);
      margin-bottom: 6px;
      padding-left: 20px;
      position: relative;
    }
    .suggestion-item::before {
      content: "‚úì";
      position: absolute;
      left: 0;
      color: #22c55e;
      font-weight: bold;
    }
    .export-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .comparison-badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(148,163,184,0.12);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 6px;
    }
    .comparison-badge.up {
      background: rgba(239,68,68,0.1);
      color: var(--danger);
    }
    .comparison-badge.down {
      background: rgba(34,197,94,0.1);
      color: #22c55e;
    }
    .chart-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 15px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }
    .chart-tab {
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(148,163,184,0.08);
      border: 1px solid transparent;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      transition: all var(--transition);
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .chart-tab:hover {
      background: rgba(148,163,184,0.15);
    }
    .chart-tab.active {
      background: var(--accent-soft);
      color: var(--accent);
      border-color: var(--accent);
    }
    .period-tab {
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(148,163,184,0.08);
      border: 1px solid transparent;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      transition: all var(--transition);
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .period-tab:hover {
      background: rgba(148,163,184,0.15);
    }
    .period-tab.active {
      background: var(--accent-soft);
      color: var(--accent);
      border-color: var(--accent);
    }
    .chart-info {
      margin-top: 12px;
      padding: 12px;
      background: rgba(15,23,42,0.02);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      font-size: 12px;
      color: var(--muted);
    }
    @media (max-width: 768px) {
      .grid { grid-template-columns: 1fr; }
      .chart-container { height: 250px; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <a class="back-link" href="dashboard.html">‚Üê Back to Dashboard</a>
      <h1><span>üìä</span> Track Spending</h1>
    </div>
    <div class="settings-pill">
      Theme: <span id="themeLabel">Light</span> ¬∑ Currency: <span id="currencyLabel">INR</span>
    </div>
  </header>

  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">üìà Monthly Overview <span class="chip">This Month</span></div>
        <div class="muted">Your spending summary and budget tracking</div>
      </div>
    </div>
    <div class="grid">
      <div class="stat-card">
        <div class="stat-label">Total Spent</div>
        <div class="stat-value" id="totalSpent">‚Çπ0</div>
        <div class="stat-subtext" id="totalSpentChange"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Average Daily</div>
        <div class="stat-value" id="avgDaily">‚Çπ0</div>
        <div class="stat-subtext">Per day this month</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Highest Expense</div>
        <div class="stat-value" id="highestExpense">‚Çπ0</div>
        <div class="stat-subtext" id="highestCategory">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Transactions</div>
        <div class="stat-value" id="transactionCount">0</div>
        <div class="stat-subtext">Total this month</div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="suggestion-box">
      <div class="suggestion-title">üí° Spending Suggestions</div>
      <div id="suggestionsContainer">
        <div class="suggestion-item">Loading suggestions...</div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">üîç Filter & Compare</div>
        <div class="muted">Analyze spending by period and category</div>
      </div>
    </div>
    <div class="filter-row">
      <select id="filterCategory">
        <option value="all">All Categories</option>
        <option value="Food">Food</option>
        <option value="Shopping">Shopping</option>
        <option value="Travel">Travel</option>
        <option value="Medical">Medical</option>
        <option value="Education">Education</option>
        <option value="Entertainment">Entertainment</option>
        <option value="Other">Other</option>
      </select>
      <input type="date" id="startDate" />
      <span style="color: var(--muted);">to</span>
      <input type="date" id="endDate" />
      <button class="btn btn-secondary" onclick="applyFilters()">Apply Filters</button>
      <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
    </div>
    <div id="filterInsights"></div>
    <div class="export-row">
      <button class="btn btn-primary" onclick="exportCSV()">üì• Export CSV</button>
      <button class="btn btn-primary" onclick="exportPDF()">üìÑ Export PDF</button>
    </div>
  </section>

  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">üìä Analytics Dashboard</div>
        <div class="muted">Click any button to switch chart type or time period</div>
      </div>
    </div>

    <!-- Time Period Selector -->
    <div class="period-tabs" style="display: flex; gap: 8px; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 12px;">
      <button class="period-tab active" onclick="switchPeriod(event, 1)">üìÖ 1M</button>
      <button class="period-tab" onclick="switchPeriod(event, 3)">üìÖ 3M</button>
      <button class="period-tab" onclick="switchPeriod(event, 6)">üìÖ 6M</button>
      <button class="period-tab" onclick="switchPeriod(event, 12)">üìÖ 12M</button>
    </div>

    <div class="chart-tabs">
      <button class="chart-tab active" onclick="switchChartType(event, 'category')">üéØ Category Breakdown</button>
      <button class="chart-tab" onclick="switchChartType(event, 'trends')">üìâ Spending Trends</button>
      <button class="chart-tab" onclick="switchChartType(event, 'comparison')">üìä Month vs Month</button>
      <button class="chart-tab" onclick="switchChartType(event, 'pie')">ü•ß Distribution Pie</button>
      <button class="chart-tab" onclick="switchChartType(event, 'bar')">üìä Monthly Bar</button>
    </div>
    <div class="chart-container">
      <canvas id="unifiedChart"></canvas>
    </div>
    <div class="chart-info" id="chartInfo"></div>
  </section>

  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">üí¨ Smart Insights</div>
        <div class="muted">Personalized spending analysis</div>
      </div>
    </div>
    <div id="insightsContainer"></div>
  </section>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
  const SETTINGS_KEY = "userSettings";
  const EXPENSES_KEY = "userExpenses";
  const CURRENCY_SYMBOLS = { INR: "‚Çπ", USD: "$", EUR: "‚Ç¨", GBP: "¬£", JPY: "¬•", AUD: "A$", CAD: "C$" };
  const API_URL = '/api';

  function getSettings() {
    try { return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {}; }
    catch { return {}; }
  }

  function getCurrencySymbol() {
    const c = getSettings().currency || "INR";
    return CURRENCY_SYMBOLS[c] || c + " ";
  }

  function applySettingsToPage() {
    const settings = getSettings();
    const theme = localStorage.getItem("appTheme") || "light";
    const currency = settings.currency || "INR";
    document.documentElement.setAttribute("data-theme", theme);
    document.getElementById("themeLabel").innerText = theme === "dark" ? "Dark" : "Light";
    document.getElementById("currencyLabel").innerText = currency;
  }

  async function loadExpenses() {
    try {
      const token = localStorage.getItem('token');
      const res = await fetch(`${API_URL}/expenses`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!res.ok) return [];
      return await res.json();
    } catch { return []; }
  }

  function getMonthStart() {
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth(), 1);
  }

  function getMonthEnd() {
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth() + 1, 0);
  }

  function getLastMonthStart() {
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth() - 1, 1);
  }

  function getLastMonthEnd() {
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth(), 0);
  }

  function filterExpensesByDate(expenses, startDate, endDate) {
    return expenses.filter(e => {
      const d = new Date(e.date);
      return d >= startDate && d <= endDate;
    });
  }

  async function calculateStats(months = 1) {
    const expenses = await loadExpenses();
    
    let thisMonth, lastMonth;
    if (months === 1) {
      thisMonth = filterExpensesByDate(expenses, getMonthStart(), getMonthEnd());
      lastMonth = filterExpensesByDate(expenses, getLastMonthStart(), getLastMonthEnd());
    } else {
      const { startDate, endDate } = getPeriodDateRange(months);
      thisMonth = filterExpensesByDate(expenses, startDate, endDate);
      const { startDate: lastStart, endDate: lastEnd } = getPeriodDateRange(months * 2);
      lastMonth = filterExpensesByDate(expenses, lastStart, new Date(lastStart.getFullYear(), lastStart.getMonth() + months, 0));
    }

    const thisMonthTotal = thisMonth.reduce((sum, e) => sum + (e.amount || 0), 0);
    const lastMonthTotal = lastMonth.reduce((sum, e) => sum + (e.amount || 0), 0);
    const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
    const avgDaily = thisMonthTotal / daysInMonth;
    const highestExpense = thisMonth.length > 0 ? Math.max(...thisMonth.map(e => e.amount || 0)) : 0;
    const highestCat = thisMonth.find(e => e.amount === highestExpense)?.category || "‚Äî";
    const change = lastMonthTotal > 0 ? ((thisMonthTotal - lastMonthTotal) / lastMonthTotal * 100).toFixed(1) : 0;

    return { thisMonthTotal, avgDaily, highestExpense, highestCat, change, transactionCount: thisMonth.length, thisMonth, lastMonth };
  }

  let unifiedChart = null;
  let chartDataCache = {};
  let currentPeriod = 1;

  function getPeriodDateRange(months) {
    const now = new Date();
    const endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    const startDate = new Date(now.getFullYear(), now.getMonth() - months + 1, 1);
    return { startDate, endDate };
  }

  async function switchPeriod(event, months) {
    currentPeriod = months;
    document.querySelectorAll(".period-tab").forEach(tab => tab.classList.remove("active"));
    event.target.classList.add("active");
    
    const stats = await calculateStats(months);
    updateCharts(stats.thisMonth);
    updateInsights(stats);
    updateSuggestions(stats);
  }

  function updateCharts(thisMonthExpenses) {
    const categoryData = {};
    thisMonthExpenses.forEach(e => {
      categoryData[e.category] = (categoryData[e.category] || 0) + e.amount;
    });
    chartDataCache.categoryData = categoryData;
    chartDataCache.thisMonthExpenses = thisMonthExpenses;
    switchChartType(null, "category");
  }

  function switchChartType(event, type) {
    if (event) {
      document.querySelectorAll(".chart-tab").forEach(tab => tab.classList.remove("active"));
      event.target.classList.add("active");
    }

    if (unifiedChart) unifiedChart.destroy();
    const ctx = document.getElementById("unifiedChart").getContext("2d");

    if (type === "category") renderCategoryChart(ctx);
    else if (type === "trends") renderTrendsChart(ctx);
    else if (type === "comparison") renderComparisonChart(ctx);
    else if (type === "pie") renderPieChart(ctx);
    else if (type === "bar") renderBarChart(ctx);
  }

  function renderCategoryChart(ctx) {
    const categoryData = chartDataCache.categoryData || {};
    const labels = Object.keys(categoryData);
    const data = Object.values(categoryData);

    unifiedChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "Spending by Category",
          data,
          backgroundColor: ["#3f67e6", "#60a5fa", "#22c55e", "#f97373", "#facc15", "#ec4899", "#8b5cf6"],
          borderRadius: 8
        }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
    });
    document.getElementById("chartInfo").innerHTML = `<strong>Category Breakdown:</strong> ${labels.length} categories | Total: ‚Çπ${data.reduce((a,b)=>a+b,0).toLocaleString()}`;
  }

  function renderTrendsChart(ctx) {
    const thisMonthExpenses = chartDataCache.thisMonthExpenses || [];
    const dailyData = {};
    thisMonthExpenses.forEach(e => {
      const d = new Date(e.date).toLocaleDateString("en-IN");
      dailyData[d] = (dailyData[d] || 0) + e.amount;
    });
    const trendLabels = Object.keys(dailyData).sort();
    const trendValues = trendLabels.map(d => dailyData[d]);

    unifiedChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: trendLabels,
        datasets: [{
          label: "Daily Spending",
          data: trendValues,
          borderColor: "#3f67e6",
          backgroundColor: "rgba(63, 103, 230, 0.1)",
          tension: 0.4,
          fill: true,
          pointRadius: 5
        }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
    });
    const avg = trendValues.length > 0 ? (trendValues.reduce((a,b)=>a+b,0)/trendValues.length).toFixed(0) : 0;
    document.getElementById("chartInfo").innerHTML = `<strong>Spending Trends:</strong> ${trendLabels.length} days | Average: ‚Çπ${avg}`;
  }

  async function renderComparisonChart(ctx) {
    const thisMonthExpenses = chartDataCache.thisMonthExpenses || [];
    const expenses = await loadExpenses();
    const lastMonth = filterExpensesByDate(expenses, getLastMonthStart(), getLastMonthEnd());
    const thisMonthCat = {};
    thisMonthExpenses.forEach(e => { thisMonthCat[e.category] = (thisMonthCat[e.category] || 0) + e.amount; });
    const lastMonthCat = {};
    lastMonth.forEach(e => { lastMonthCat[e.category] = (lastMonthCat[e.category] || 0) + e.amount; });
    const allCats = [...new Set([...Object.keys(thisMonthCat), ...Object.keys(lastMonthCat)])];

    unifiedChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: allCats,
        datasets: [
          { label: "This Month", data: allCats.map(c => thisMonthCat[c] || 0), backgroundColor: "#3f67e6" },
          { label: "Last Month", data: allCats.map(c => lastMonthCat[c] || 0), backgroundColor: "rgba(96, 165, 250, 0.4)" }
        ]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true } }, indexAxis: "y", scales: { x: { beginAtZero: true } } }
    });
    const thisTotal = allCats.reduce((sum,c)=>sum+(thisMonthCat[c]||0),0);
    const lastTotal = allCats.reduce((sum,c)=>sum+(lastMonthCat[c]||0),0);
    document.getElementById("chartInfo").innerHTML = `<strong>Month Comparison:</strong> This: ‚Çπ${thisTotal.toLocaleString()} | Last: ‚Çπ${lastTotal.toLocaleString()}`;
  }

  function renderPieChart(ctx) {
    const categoryData = chartDataCache.categoryData || {};
    const labels = Object.keys(categoryData);
    const data = Object.values(categoryData);

    unifiedChart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels,
        datasets: [{
          data,
          backgroundColor: ["#3f67e6", "#60a5fa", "#22c55e", "#f97373", "#facc15", "#ec4899", "#8b5cf6"],
          borderWidth: 2
        }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: "bottom" } } }
    });
    const total = data.reduce((a,b)=>a+b,0);
    document.getElementById("chartInfo").innerHTML = `<strong>Distribution Pie:</strong> ${labels.length} categories | Total: ‚Çπ${total.toLocaleString()}`;
  }

  function renderBarChart(ctx) {
    const categoryData = chartDataCache.categoryData || {};
    const labels = Object.keys(categoryData);
    const data = Object.values(categoryData);

    unifiedChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "Monthly Spending",
          data,
          backgroundColor: ["#ec4899", "#8b5cf6", "#3f67e6", "#22c55e", "#f97373", "#facc15", "#60a5fa"],
          borderRadius: 10
        }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
    });
    const total = data.reduce((a,b)=>a+b,0);
    document.getElementById("chartInfo").innerHTML = `<strong>Monthly Bar Chart:</strong> ${labels.length} categories | Total: ‚Çπ${total.toLocaleString()}`;
  }

  async function updateDashboard() {
    const stats = await calculateStats();
    const symbol = getCurrencySymbol();
    document.getElementById("totalSpent").innerText = symbol + stats.thisMonthTotal.toLocaleString("en-IN");
    document.getElementById("avgDaily").innerText = symbol + Math.round(stats.avgDaily).toLocaleString("en-IN");
    document.getElementById("highestExpense").innerText = symbol + stats.highestExpense.toLocaleString("en-IN");
    document.getElementById("highestCategory").innerText = "Category: " + stats.highestCat;
    document.getElementById("transactionCount").innerText = stats.transactionCount;

    const changeEl = document.getElementById("totalSpentChange");
    if (stats.change > 0) {
      changeEl.innerHTML = `<span class="comparison-badge up">‚Üë ${stats.change}% vs last month</span>`;
    } else if (stats.change < 0) {
      changeEl.innerHTML = `<span class="comparison-badge down">‚Üì ${Math.abs(stats.change)}% vs last month</span>`;
    } else {
      changeEl.innerHTML = `<span class="comparison-badge">Same as last month</span>`;
    }

    updateCharts(stats.thisMonth);
    updateInsights(stats);
    updateSuggestions(stats);
  }

  function updateSuggestions(stats) {
    const suggestions = [];
    const symbol = getCurrencySymbol();

    if (stats.change > 20) {
      suggestions.push(`Your spending is <strong>${stats.change}% higher</strong> than last month. Consider reducing expenses.`);
    }

    const catSpending = {};
    stats.thisMonth.forEach(e => {
      catSpending[e.category] = (catSpending[e.category] || 0) + e.amount;
    });

    if (Object.keys(catSpending).length > 0) {
      const topCat = Object.keys(catSpending).reduce((a, b) => catSpending[a] > catSpending[b] ? a : b);
      const topCatPercent = ((catSpending[topCat] / stats.thisMonthTotal) * 100).toFixed(0);
      if (topCatPercent > 40) {
        suggestions.push(`<strong>${topCat}</strong> is ${topCatPercent}% of your spending. Try to optimize this category.`);
      }
    }

    if (stats.avgDaily > 500) {
      suggestions.push(`Your average daily spending is ${symbol}${Math.round(stats.avgDaily)}. Aim to reduce it.`);
    }

    if (stats.transactionCount > 30) {
      suggestions.push(`You have <strong>${stats.transactionCount} transactions</strong> this month. Consider consolidating purchases.`);
    }

    if (stats.thisMonthTotal < stats.lastMonth.reduce((sum, e) => sum + (e.amount || 0), 0)) {
      suggestions.push(`Great job! You're spending <strong>less</strong> than last month. Keep it up! üéâ`);
    }

    if (suggestions.length === 0) {
      suggestions.push("Your spending looks balanced. No major concerns detected.");
    }

    document.getElementById("suggestionsContainer").innerHTML = suggestions.map(s => `<div class="suggestion-item">${s}</div>`).join("");
  }

  function updateInsights(stats) {
    const insights = [];
    const symbol = getCurrencySymbol();
    insights.push(`This month you've spent <strong>${symbol}${stats.thisMonthTotal.toLocaleString("en-IN")}</strong> across <strong>${stats.transactionCount} transactions</strong>.`);
    if (stats.highestExpense > 0) {
      insights.push(`Your highest single expense was <strong>${symbol}${stats.highestExpense.toLocaleString("en-IN")}</strong> in the <strong>${stats.highestCat}</strong> category.`);
    }
    const daysLeft = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate() - new Date().getDate();
    const projectedSpending = (stats.avgDaily * new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate()).toLocaleString("en-IN");
    insights.push(`With <strong>${daysLeft} days remaining</strong>, projected monthly spending is around <strong>${symbol}${projectedSpending}</strong>.`);
    document.getElementById("insightsContainer").innerHTML = insights.map(s => `<div class="insight-box">${s}</div>`).join("");
  }

  async function applyFilters() {
    const category = document.getElementById("filterCategory").value;
    const startDate = new Date(document.getElementById("startDate").value);
    const endDate = new Date(document.getElementById("endDate").value);

    if (!document.getElementById("startDate").value || !document.getElementById("endDate").value) {
      alert("Please select both start and end dates.");
      return;
    }

    let expenses = await loadExpenses();
    expenses = filterExpensesByDate(expenses, startDate, endDate);
    if (category !== "all") {
      expenses = expenses.filter(e => e.category === category);
    }
    const total = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
    const symbol = getCurrencySymbol();
    document.getElementById("filterInsights").innerHTML = `<div class="insight-box"><strong>Filtered Results:</strong> ${expenses.length} transactions totaling <strong>${symbol}${total.toLocaleString("en-IN")}</strong> ${category !== "all" ? ` in <strong>${category}</strong>` : ""}</div>`;
  }

  function resetFilters() {
    document.getElementById("filterCategory").value = "all";
    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";
    document.getElementById("filterInsights").innerHTML = "";
  }

  async function exportCSV() {
    const expenses = await loadExpenses();
    const thisMonth = filterExpensesByDate(expenses, getMonthStart(), getMonthEnd());
    let csv = "Date,Category,Amount,Note,Currency\n";
    thisMonth.forEach(e => {
      const date = new Date(e.date).toLocaleDateString("en-IN");
      csv += `${date},${e.category},${e.amount},"${e.note}",${e.currency}\n`;
    });
    const link = document.createElement("a");
    link.href = "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
    link.download = "spending-" + new Date().toISOString().split("T")[0] + ".csv";
    link.click();
  }

  async function exportPDF() {
    const stats = await calculateStats();
    const symbol = getCurrencySymbol();
    const element = document.createElement("div");
    element.style.padding = "20px";
    element.style.fontFamily = "Arial, sans-serif";
    element.innerHTML = `
      <h1 style="margin-bottom: 15px; color: var(--text);">Spending Report - ${new Date().toLocaleDateString()}</h1>
      <hr style="margin: 15px 0;"/>
      <p><strong>Total Spent:</strong> ${symbol}${stats.thisMonthTotal.toLocaleString()}</p>
      <p><strong>Transactions:</strong> ${stats.transactionCount}</p>
      <p><strong>Average Daily:</strong> ${symbol}${Math.round(stats.avgDaily).toLocaleString()}</p>
      <p><strong>Highest Expense:</strong> ${symbol}${stats.highestExpense.toLocaleString()} (${stats.highestCat})</p>
    `;
    
    const opt = {
      margin: 10,
      filename: 'spending-report-' + new Date().toISOString().split('T')[0] + '.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
    };
    
    html2pdf().set(opt).from(element).save();
  }

  applySettingsToPage();
  document.getElementById("startDate").valueAsDate = getMonthStart();
  document.getElementById("endDate").valueAsDate = getMonthEnd();
  updateDashboard();
</script>
</body>
</html>